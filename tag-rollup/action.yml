name: Tag rollup check
description: Check commits since a moving tag (run nightly or before deployment)
author: Terje Sandstrom
branding:
  icon: git-commit
  color: blue

inputs:
  tag:
    description: Tag name to compare (e.g., last-deploy or last-deploy/prod)
    required: true
    default: last-deploy
  initial_as_changes:
    description: If no tag exists, treat as changes (true) or no changes (false)
    default: "true"

outputs:
  has_changes:
    description: true if HEAD is ahead of the tag (or initial_as_changes == true and tag missing)
    value: ${{ steps.check.outputs.has_changes }}
  base_tag:
    description: The tag name if present, else empty
    value: ${{ steps.check.outputs.base_tag }}
  ahead:
    description: Number of commits ahead of tag
    value: ${{ steps.check.outputs.ahead }}
  current_branch:
    description: The current branch or ref
    value: ${{ steps.check.outputs.current_branch }}

runs:
  using: composite
  steps:
    - id: check
      shell: bash
      run: |
        set -euo pipefail
        tag="${{ inputs.tag }}"
        initial="${{ inputs.initial_as_changes }}"

        echo "ðŸ“¦ Checking for commits since tag '$tag'..."
        echo ""
        
        # Get current context
        current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "HEAD")
        current_sha=$(git rev-parse HEAD)
        
        echo "Branch: $current_branch @ ${current_sha:0:7}"
        echo "Looking for tag: '$tag'"
        echo ""
        
        # Force fetch all tags (needed to find any deployment tag)
        echo "Fetching tags from origin..."
        git fetch origin '+refs/tags/*:refs/tags/*' --force --prune --no-recurse-submodules 2>&1 | head -3
        echo ""

        base=""
        ahead=0

        if git rev-parse -q --verify "refs/tags/$tag" >/dev/null 2>&1; then
          tag_sha=$(git rev-parse "refs/tags/$tag")
          tag_short=$(git rev-parse --short "refs/tags/$tag")
          echo "âœ“ Found tag '$tag' at $tag_short"
          
          # Check if tag is an ancestor of HEAD
          if git merge-base --is-ancestor "refs/tags/$tag" HEAD 2>/dev/null; then
            ahead=$(git rev-list --count "refs/tags/$tag"..HEAD)
            base="$tag"
            reason="$ahead commit(s) since '$tag' ($tag_short)."
            echo "âœ“ Tag is ancestor of HEAD, $ahead commits ahead"
          else
            echo "âš ï¸ WARNING: Tag '$tag' exists but is NOT an ancestor of HEAD"
            echo "   This usually means the tag was created on a different branch"
            
            if [ "$initial" = "true" ]; then
              ahead=$(git rev-list --count HEAD)
              reason="âš ï¸ Tag '$tag' found but NOT in current branch history. Treating as initial run ($ahead commits)."
            else
              ahead=0
              reason="âš ï¸ Tag '$tag' found but NOT in current branch history. initial_as_changes=false, so no run."
            fi
          fi
        else
          echo "âœ— Tag '$tag' NOT found"
          
          # Only do expensive similarity search if tag not found
          echo ""
          echo "ðŸ” Searching for similar tags..."
          all_tags=$(git tag -l | sort -V)
          similar_tags=$(echo "$all_tags" | grep -i "deploy" | head -10 || echo "")
          
          if [ -n "$similar_tags" ]; then
            echo "   Found similar tags:"
            echo "$similar_tags" | while read -r t; do
              echo "     - $t"
            done
            
            # Check for common typos
            if echo "$similar_tags" | grep -q "^last-deploy"; then
              if [ "$tag" = "latest-deploy" ] || [[ "$tag" == latest-deploy* ]]; then
                echo ""
                echo "   âš ï¸  TYPO DETECTED: You searched for '$tag'"
                echo "       but 'last-deploy*' tags exist!"
                echo "       Did you mean 'last' instead of 'latest'?"
              fi
            fi
          else
            echo "   No tags containing 'deploy' found"
          fi
          echo ""
          
          if [ "$initial" = "true" ]; then
            ahead="$(git rev-list --count HEAD)"
            reason="âŒ No tag '$tag' found; treating as initial run ($ahead commits)."
          else
            ahead="0"
            reason="âŒ No tag '$tag' found; initial_as_changes=false, so no run."
          fi
        fi

        if [ "$ahead" -gt 0 ]; then
          has_changes="true"
        else
          has_changes="false"
        fi

        {
          echo "has_changes=$has_changes"
          echo "base_tag=$base"
          echo "ahead=$ahead"
          echo "current_branch=$current_branch"
        } >> "$GITHUB_OUTPUT"
        
        # Summary
        {
          echo "### Tag rollup check"
          echo "- **Branch**: \`$current_branch\` @ \`${current_sha:0:7}\`"
          echo "- **Tag searched**: \`$tag\`"
          echo "- **Found tag**: \`${base:-ã€ˆnoneã€‰}\`"
          if [ -z "$base" ] && [ -n "${similar_tags:-}" ]; then
            echo ""
            echo "#### ðŸ” Similar tags found:"
            echo "$similar_tags" | head -5 | while read -r t; do
              echo "- \`$t\`"
            done
          fi
          echo "- **Commits ahead**: \`$ahead\`"
          echo "- **Decision**: \`${has_changes}\`"
          echo ""
          echo "$reason"
        } >> "$GITHUB_STEP_SUMMARY"

        echo ""
        echo "Result: has_changes=$has_changes, base_tag=${base:-none}, ahead=$ahead"
