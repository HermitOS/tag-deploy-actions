name: Tag rollup check
description: Check commits since a moving tag (run nightly or before deployment)
author: Terje Sandstrom
branding:
  icon: git-commit
  color: blue

inputs:
  tag:
    description: Tag name to compare (e.g., last-deploy or last-deploy/prod)
    required: true
    default: last-deploy
  initial_as_changes:
    description: If no tag exists, treat as changes (true) or no changes (false)
    default: "true"

outputs:
  has_changes:
    description: true if HEAD is ahead of the tag (or initial_as_changes == true and tag missing)
  base_tag:
    description: The tag name if present, else empty
  ahead:
    description: Number of commits ahead of tag

runs:
  using: composite
  steps:
    - shell: bash
      run: git fetch --tags --force

    - id: check
      shell: bash
      run: |
        set -euo pipefail
        tag="${{ inputs.tag }}"
        initial="${{ inputs.initial_as_changes }}"

        echo "ðŸ“¦ Fetching tagsâ€¦"
        git fetch --tags --force >/dev/null 2>&1 || true

        base=""
        ahead=0

        if git rev-parse -q --verify "refs/tags/$tag" >/dev/null; then
          ahead=$(git rev-list --count "$tag"..HEAD)
          base="$tag"
          reason="$ahead commit(s) since '$tag'."
        else
          if [ "$initial" = "true" ]; then
            ahead="$(git rev-list --count HEAD)"
            reason="No tag '$tag' found; treating as initial run."
          else
            ahead="0"
            reason="No tag '$tag' found; initial_as_changes=false, so no run."
          fi
        fi

        if [ "$ahead" -gt 0 ]; then
          has_changes="true"
        else
          has_changes="false"
        fi

        {
          echo "has_changes=$has_changes"
          echo "base_tag=$base"
          echo "ahead=$ahead"
        } >> "$GITHUB_OUTPUT"
        
        # Summary
        {
          echo "### Tag rollup check"
          echo "- Tag: \`$tag\`"
          echo "- Found tag: \`${base:-ã€ˆnoneã€‰}\`"
          echo "- Commits ahead: \`$ahead\`"
          echo "- Decision: \`${has_changes}\`"
          echo ""
          echo "$reason"
        } >> "$GITHUB_STEP_SUMMARY"
        
        # Also echo to logs for quick visibility
        echo "has_changes=$has_changes, base_tag=${base:-none}, ahead=$ahead â€” $reason"
