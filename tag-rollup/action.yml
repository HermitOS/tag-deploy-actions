name: Tag rollup check
description: Check commits since a moving tag (run nightly or before deployment)
author: Terje Sandstrom
branding:
  icon: git-commit
  color: blue

inputs:
  tag:
    description: Tag name to compare (e.g., last-deploy or last-deploy/prod)
    required: true
    default: last-deploy
  initial_as_changes:
    description: If no tag exists, treat as changes (true) or no changes (false)
    default: "true"

outputs:
  has_changes:
    description: true if HEAD is ahead of the tag (or initial_as_changes == true and tag missing)
    value: ${{ steps.check.outputs.has_changes }}
  base_tag:
    description: The tag name if present, else empty
    value: ${{ steps.check.outputs.base_tag }}
  ahead:
    description: Number of commits ahead of tag
    value: ${{ steps.check.outputs.ahead }}
  current_branch:
    description: The current branch or ref
    value: ${{ steps.check.outputs.current_branch }}

runs:
  using: composite
  steps:
    - id: check
      shell: bash
      run: |
        set -euo pipefail
        tag="${{ inputs.tag }}"
        initial="${{ inputs.initial_as_changes }}"

        echo "ğŸ“¦ Fetching tags and checking branch contextâ€¦"
        
        # Get current branch/ref info
        current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "HEAD")
        current_sha=$(git rev-parse HEAD)
        
        echo "Current branch: $current_branch"
        echo "Current SHA: $current_sha"
        echo "Looking for tag: $tag"
        
        # Show git config for debugging
        echo ""
        echo "Git remote configuration:"
        git remote -v || echo "No remotes configured"
        
        # CRITICAL: Multiple fetch attempts to ensure tags are retrieved
        echo ""
        echo "Fetching tags (attempt 1: explicit refspec)..."
        git fetch origin '+refs/tags/*:refs/tags/*' --force --prune --no-recurse-submodules 2>&1 || echo "Fetch attempt 1 had issues"
        
        echo ""
        echo "Fetching tags (attempt 2: with --tags flag)..."
        git fetch origin --tags --force 2>&1 || echo "Fetch attempt 2 had issues"
        
        # Show what we have
        echo ""
        echo "Tags in .git/refs/tags/:"
        ls -la .git/refs/tags/ 2>/dev/null || echo "No .git/refs/tags/ directory"
        
        echo ""
        echo "All refs containing 'tag':"
        git show-ref | grep tag || echo "No tag refs found"
        
        echo ""
        echo "Available tags after fetch:"
        git tag -l | sort -V | tail -10 || echo "No tags found via git tag -l"
        
        # Check if our specific tag exists
        echo ""
        echo "Checking for tag: $tag"
        if git show-ref --verify --quiet "refs/tags/$tag" 2>/dev/null; then
          echo "âœ“ Tag reference exists in refs/tags/"
        else
          echo "âœ— Tag reference NOT found in refs/tags/"
        fi

        base=""
        ahead=0

        if git rev-parse -q --verify "refs/tags/$tag" >/dev/null 2>&1; then
          tag_sha=$(git rev-parse "refs/tags/$tag")
          tag_short=$(git rev-parse --short "refs/tags/$tag")
          echo "âœ“ Found tag '$tag' at SHA: $tag_sha ($tag_short)"
          
          # Check if tag is an ancestor of HEAD
          if git merge-base --is-ancestor "refs/tags/$tag" HEAD 2>/dev/null; then
            ahead=$(git rev-list --count "refs/tags/$tag"..HEAD)
            base="$tag"
            reason="$ahead commit(s) since '$tag' ($tag_short)."
            echo "âœ“ Tag is ancestor of HEAD, $ahead commits ahead"
          else
            echo "âš  Tag '$tag' exists at $tag_sha but is NOT an ancestor of HEAD ($current_sha)"
            if [ "$initial" = "true" ]; then
              ahead=$(git rev-list --count HEAD)
              reason="Tag '$tag' found but not in current branch history. Treating as initial run ($ahead commits)."
            else
              ahead=0
              reason="Tag '$tag' found but not in current branch history. initial_as_changes=false, so no run."
            fi
          fi
        else
          echo "âŒ ERROR: Tag '$tag' NOT found!"
          echo ""
          
          # Try to find similar tags (fuzzy matching)
          echo "ğŸ” Looking for similar tags..."
          similar_tags=$(echo "$all_tags" | grep -i "deploy" || echo "")
          
          if [ -n "$similar_tags" ]; then
            echo "   Did you mean one of these?"
            echo "$similar_tags" | while read -r t; do
              echo "     - $t"
            done
            echo ""
            
            # Check for common typos
            if echo "$all_tags" | grep -q "^last-deploy"; then
              if [ "$tag" = "latest-deploy" ] || [[ "$tag" == latest-deploy* ]]; then
                echo "   âš ï¸  TYPO DETECTED: You searched for '$tag' but 'last-deploy*' tags exist!"
                echo "   Did you accidentally type 'latest' instead of 'last'?"
              fi
            fi
          else
            echo "   No tags containing 'deploy' found."
          fi
          echo ""
          
          if [ "$initial" = "true" ]; then
            ahead="$(git rev-list --count HEAD)"
            reason="âŒ No tag '$tag' found; treating as initial run ($ahead commits)."
          else
            ahead="0"
            reason="No tag '$tag' found; initial_as_changes=false, so no run."
          fi
        fi

        if [ "$ahead" -gt 0 ]; then
          has_changes="true"
        else
          has_changes="false"
        fi

        {
          echo "has_changes=$has_changes"
          echo "base_tag=$base"
          echo "ahead=$ahead"
          echo "current_branch=$current_branch"
        } >> "$GITHUB_OUTPUT"
        
        # Summary
        {
          echo "### Tag rollup check"
          echo "- **Branch**: \`$current_branch\` @ \`${current_sha:0:7}\`"
          echo "- **Tag searched**: \`$tag\`"
          echo "- **Found tag**: \`${base:-ã€ˆnoneã€‰}\`"
          if [ -z "$base" ] && [ -n "${similar_tags:-}" ]; then
            echo ""
            echo "#### âš ï¸ Tag Not Found - Did you mean?"
            echo "$similar_tags" | while read -r t; do
              echo "- \`$t\`"
            done
          fi
          echo "- **Commits ahead**: \`$ahead\`"
          echo "- **Decision**: \`${has_changes}\`"
          echo ""
          echo "$reason"
        } >> "$GITHUB_STEP_SUMMARY"

        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Result: has_changes=$has_changes, base_tag=${base:-none}, ahead=$ahead"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
