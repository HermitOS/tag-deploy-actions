name: Tag push
description: Move a tag to HEAD and push it to the remote after a successful deploy
author: Terje Sandstrom
branding:
  icon: tag
  color: green

inputs:
  tag:
    description: Tag name to move and push (e.g., last-deploy)
    required: true
    default: last-deploy
  remote:
    description: Git remote name
    default: origin

runs:
  using: composite
  steps:
    - shell: bash
      run: |
        set -euo pipefail
        tag="${{ inputs.tag }}"
        remote="${{ inputs.remote }}"
        
        # Get current context for debugging
        current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "HEAD")
        current_sha=$(git rev-parse HEAD)
        current_short=$(git rev-parse --short HEAD)
        
        echo "ðŸ·ï¸ Moving '$tag' to HEAD and pushing to '$remote'â€¦"
        echo "Current branch: $current_branch"
        echo "Current HEAD: $current_sha"
        
        # Fetch tags to see current state
        echo "Fetching current tags..."
        git fetch "$remote" '+refs/tags/*:refs/tags/*' --force 2>&1 | head -5 || true
        
        # Show old tag location if it exists
        if git rev-parse -q --verify "refs/tags/$tag" >/dev/null; then
          old_sha=$(git rev-parse "refs/tags/$tag")
          old_short=$(git rev-parse --short "refs/tags/$tag")
          echo "Old tag location: $old_sha ($old_short)"
        else
          echo "Tag does not exist yet (will create new)"
        fi
        
        # Force move/create tag to current HEAD
        git tag -f "$tag"
        new_local_sha=$(git rev-parse "refs/tags/$tag")
        echo "âœ“ Tag moved locally to $new_local_sha"
        
        # Verify local tag before pushing
        if [ "$new_local_sha" != "$current_sha" ]; then
          echo "âœ— ERROR: Local tag is at $new_local_sha but HEAD is at $current_sha"
          exit 1
        fi
        
        # Force push to remote with explicit refspec
        echo "Pushing tag to remote..."
        git push -f "$remote" "refs/tags/$tag:refs/tags/$tag"
        echo "âœ“ Tag pushed to $remote"
        
        # Verify on remote
        echo "Verifying tag on remote..."
        git fetch "$remote" '+refs/tags/*:refs/tags/*' --force 2>&1 | head -5 || true
        remote_sha=$(git ls-remote "$remote" "refs/tags/$tag" | cut -f1)
        echo "Remote tag SHA: $remote_sha"
        
        if [ "$remote_sha" = "$current_sha" ]; then
          echo "âœ“ Verified: Remote tag matches HEAD"
        else
          echo "âš  WARNING: Remote tag ($remote_sha) doesn't match HEAD ($current_sha)"
        fi
        
        {
          echo "### Tag push"
          echo "- **Tag moved**: \`$tag\`"
          echo "- **Remote**: \`$remote\`"
          echo "- **Branch**: \`$current_branch\`"
          echo "- **New location**: \`$current_short\` (\`$current_sha\`)"
          if [ -n "${old_short:-}" ]; then
            echo "- **Previous location**: \`$old_short\` (\`$old_sha\`)"
          fi
        } >> "$GITHUB_STEP_SUMMARY"
        
        echo "âœ“ Complete: $tag â†’ $current_short"
